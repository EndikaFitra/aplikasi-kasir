-- =============================================
-- 1. BERSIHKAN DATABASE (Opsional: Hati-hati!)
-- =============================================
-- Hapus comment di bawah jika ingin mereset total database (DATA AKAN HILANG)
-- DROP TABLE IF EXISTS transaction_payments CASCADE;
-- DROP TABLE IF EXISTS transaction_items CASCADE;
-- DROP TABLE IF EXISTS transactions CASCADE;
-- DROP TABLE IF EXISTS customers CASCADE;
-- DROP TABLE IF EXISTS products CASCADE;
-- DROP TYPE IF EXISTS payment_method_type CASCADE;


-- =============================================
-- 2. SETUP TIPE DATA CUSTOM
-- =============================================
CREATE TYPE payment_method_type AS ENUM ('CASH', 'PIUTANG');


-- =============================================
-- 3. TABEL PRODUK (Master Barang)
-- =============================================
CREATE TABLE products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nama TEXT NOT NULL,
  barcode TEXT,
  harga_beli NUMERIC(15, 2) NOT NULL DEFAULT 0,
  harga_jual NUMERIC(15, 2) NOT NULL DEFAULT 0,
  stok INTEGER NOT NULL DEFAULT 0 CHECK (stok >= 0), -- Mencegah stok minus
  created_at TIMESTAMPTZ DEFAULT NOW()
);


-- =============================================
-- 4. TABEL CUSTOMERS (Pelanggan)
-- =============================================
CREATE TABLE customers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nama TEXT NOT NULL,
  no_hp TEXT,
  alamat TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);


-- =============================================
-- 5. TABEL TRANSACTIONS (Nota Penjualan)
-- =============================================
CREATE TABLE transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  customer_id BIGINT REFERENCES customers(id) ON DELETE SET NULL,
  
  -- Data Keuangan
  total_amount NUMERIC(15, 2) NOT NULL DEFAULT 0,
  payment_method payment_method_type NOT NULL DEFAULT 'CASH',
  
  -- Status Transaksi & Piutang
  status TEXT DEFAULT 'COMPLETED', -- COMPLETED, CANCELLED
  payment_status TEXT DEFAULT 'LUNAS', -- LUNAS, BELUM_LUNAS
  remaining_amount NUMERIC(15, 2) DEFAULT 0, -- Sisa hutang (0 jika cash/lunas)
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);


-- =============================================
-- 6. TABEL TRANSACTION ITEMS (Detail Barang per Nota)
-- =============================================
CREATE TABLE transaction_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  transaction_id UUID REFERENCES transactions(id) ON DELETE CASCADE,
  product_id BIGINT REFERENCES products(id) ON DELETE RESTRICT, -- Jangan hapus produk jika ada transaksi
  
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  price_at_transaction NUMERIC(15, 2) NOT NULL, -- Harga saat transaksi terjadi (Snapshot)
  subtotal NUMERIC(15, 2) GENERATED ALWAYS AS (quantity * price_at_transaction) STORED
);


-- =============================================
-- 7. TABEL TRANSACTION PAYMENTS (Riwayat Cicilan)
-- =============================================
CREATE TABLE transaction_payments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  transaction_id UUID REFERENCES transactions(id) ON DELETE CASCADE,
  amount NUMERIC(15, 2) NOT NULL, -- Jumlah uang yang dibayarkan
  note TEXT, -- Catatan opsional
  created_at TIMESTAMPTZ DEFAULT NOW()
);


-- =============================================
-- 8. TRIGGER OTOMATIS (Business Logic)
-- =============================================

-- Fungsi: Kurangi stok saat item transaksi ditambahkan
CREATE OR REPLACE FUNCTION reduce_stock_on_transaction()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE products
  SET stok = stok - NEW.quantity
  WHERE id = NEW.product_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Pasang fungsi di tabel items
CREATE TRIGGER tr_reduce_stock
AFTER INSERT ON transaction_items
FOR EACH ROW
EXECUTE FUNCTION reduce_stock_on_transaction();


-- =============================================
-- 9. KEAMANAN (Row Level Security / RLS)
-- =============================================

-- Aktifkan RLS di semua tabel
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transaction_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE transaction_payments ENABLE ROW LEVEL SECURITY;

-- Kebijakan: Hanya User Login (Authenticated) yang boleh akses penuh
-- (Insert, Update, Select, Delete)
CREATE POLICY "Full access for authenticated users" ON products FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Full access for authenticated users" ON customers FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Full access for authenticated users" ON transactions FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Full access for authenticated users" ON transaction_items FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Full access for authenticated users" ON transaction_payments FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- =============================================
-- 10. DUMMY DATA (Untuk Test Awal - Opsional)
-- =============================================

-- Insert 1 Produk Contoh
INSERT INTO products (nama, barcode, harga_beli, harga_jual, stok)
VALUES ('Kopi Susu Gula Aren', '899123456', 10000, 18000, 50);

-- Insert 1 Customer Umum
INSERT INTO customers (nama, no_hp, alamat)
VALUES ('Pelanggan Umum', '-', '-');